<!DOCTYPE html>
<html>
  <head>
    <title>Muse S Athena Test</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.1.0"></script>
    <script src="plugins/jspsych-psychophysics.js"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  </head>
  <body></body>
  <script>

    /* initialize jsPsych */
    var jsPsych = initJsPsych(
      {override_safe_mode: true,
      show_progress_bar: "true",
      message_progress_bar: "Progress"});

    function sendMarker(value) {
      fetch(`http://localhost:5000/marker?value=${encodeURIComponent(value)}`)
      .catch(err => console.error("Marker send error:", err));
    }

    /* create timeline */
    var timeline = [];
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;
            
            
    /* enter fullscreen */
    var fullscreen_text = "<p>The experiment will switch to full screen mode when you press the button below</p>"
    var fullscreen_button = "Continue"

    var fullscreen_on = {
    type: jsPsychFullscreen,
    message: fullscreen_text,
    button_label: fullscreen_button,
    fullscreen_mode: true,
    delay_after: 0,}

    var fullscreen_off = {
    type: jsPsychFullscreen,
    message: fullscreen_text,
    button_label: fullscreen_button,
    fullscreen_mode: false,}

    timeline.push(fullscreen_on);


    /* preload images */
    // list of all images in the stimuli/ folder - stimuli from the Face Research Lab London Set
    var stimuli_images = [
      'stimuli/001_03.jpg', 'stimuli/002_03.jpg', 'stimuli/003_03.jpg', 'stimuli/004_03.jpg',
      'stimuli/005_03.jpg', 'stimuli/006_03.jpg', 'stimuli/007_03.jpg', 'stimuli/008_03.jpg',
      'stimuli/009_03.jpg', 'stimuli/010_03.jpg', 'stimuli/011_03.jpg', 'stimuli/012_03.jpg',
      'stimuli/013_03.jpg', 'stimuli/014_03.jpg', 'stimuli/016_03.jpg', 'stimuli/017_03.jpg',
      'stimuli/018_03.jpg', 'stimuli/019_03.jpg', 'stimuli/020_03.jpg', 'stimuli/021_03.jpg',
      'stimuli/022_03.jpg', 'stimuli/024_03.jpg', 'stimuli/025_03.jpg', 'stimuli/026_03.jpg',
      'stimuli/027_03.jpg', 'stimuli/029_03.jpg', 'stimuli/030_03.jpg', 'stimuli/031_03.jpg',
      'stimuli/032_03.jpg', 'stimuli/033_03.jpg', 'stimuli/034_03.jpg', 'stimuli/036_03.jpg',
      'stimuli/037_03.jpg', 'stimuli/038_03.jpg', 'stimuli/039_03.jpg', 'stimuli/041_03.jpg',
      'stimuli/042_03.jpg', 'stimuli/043_03.jpg', 'stimuli/044_03.jpg', 'stimuli/045_03.jpg',
      'stimuli/061_03.jpg', 'stimuli/062_03.jpg', 'stimuli/063_03.jpg', 'stimuli/064_03.jpg',
      'stimuli/066_03.jpg', 'stimuli/067_03.jpg', 'stimuli/068_03.jpg', 'stimuli/069_03.jpg',
      'stimuli/070_03.jpg', 'stimuli/081_03.jpg', 'stimuli/082_03.jpg', 'stimuli/083_03.jpg',
      'stimuli/086_03.jpg', 'stimuli/087_03.jpg', 'stimuli/090_03.jpg', 'stimuli/091_03.jpg',
      'stimuli/092_03.jpg', 'stimuli/094_03.jpg', 'stimuli/096_03.jpg', 'stimuli/097_03.jpg',
      'stimuli/099_03.jpg', 'stimuli/100_03.jpg', 'stimuli/101_03.jpg', 'stimuli/102_03.jpg',
      'stimuli/103_03.jpg', 'stimuli/104_03.jpg', 'stimuli/105_03.jpg', 'stimuli/107_03.jpg',
      'stimuli/108_03.jpg', 'stimuli/112_03.jpg', 'stimuli/113_03.jpg', 'stimuli/114_03.jpg',
      'stimuli/115_03.jpg', 'stimuli/117_03.jpg', 'stimuli/118_03.jpg', 'stimuli/119_03.jpg',
      'stimuli/120_03.jpg', 'stimuli/121_03.jpg', 'stimuli/122_03.jpg', 'stimuli/123_03.jpg',
      'stimuli/124_03.jpg', 'stimuli/125_03.jpg', 'stimuli/126_03.jpg', 'stimuli/127_03.jpg',
      'stimuli/128_03.jpg', 'stimuli/129_03.jpg', 'stimuli/130_03.jpg', 'stimuli/131_03.jpg',
      'stimuli/132_03.jpg', 'stimuli/134_03.jpg', 'stimuli/135_03.jpg', 'stimuli/136_03.jpg',
      'stimuli/137_03.jpg', 'stimuli/138_03.jpg', 'stimuli/139_03.jpg', 'stimuli/140_03.jpg',
      'stimuli/141_03.jpg', 'stimuli/142_03.jpg', 'stimuli/143_03.jpg', 'stimuli/144_03.jpg',
      'stimuli/172_03.jpg', 'stimuli/173_03.jpg'
    ];

    var preload = {
      type: jsPsychPreload,
      images: stimuli_images
    }
    timeline.push(preload);

    /* Here I was going to make the trigger marker dissapear when 'm' or 'f' are pressed 
    so it would disappear when participants responded to stimuli, rather than flashing for 100ms which may be distracting.
    But the whole screen goes grey instead of it actually just being a black rectangle in the corner, 
    so I couldn't find a way to do this with the psPsychophysics plugin- if need be, could investigate how ReBel have
    previously made the trigger marker react to keybaord responses e.g. PRIMALS 
    const trigger_marker = {
    type: jsPsychPsychophysics,
    stimuli: [
      {
        obj_type: 'rect',
        startX: 0,
        startY: 0,
        width: 200,
        height: 150,
        fill_color: '#000000',
        show_start_time: 0
      }
    ],
    trial_duration: 9999,
    response_allowed_while_playing: false,
    choices: ['m', 'f']
  };
  timeline.push(trigger_marker); */


    /* define welcome message trial */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome);


    /* define instructions trial */
    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>In this experiment, a picture of a Person will appear in the center 
        of the screen.</p><p>If the Person is <strong>Male</strong>, 
        press the letter M on the keyboard as fast as you can.</p>
        <p>If the Person is <strong>Female</strong>, press the letter F 
        as fast as you can.</p>
        <style>
          .color-demo { width: 80px; height: 80px; border-radius: 50%; display: inline-block; }
          .left { float: left; text-align: center; }
          .right { float: right; text-align: center; }
          .demo-container { width: 700px; overflow: auto; }
        </style>
        <p>Press any key to begin.</p>
      `,
      post_trial_gap: 2000
    };
    timeline.push(instructions);

  var fixation = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div style="font-size:60px;">+</div>',
  choices: "NO_KEYS",
  trial_duration: Math.floor(Math.random() * 2000) + 1000, // Random duration between 1000 and 3000 ms
};
timeline.push(fixation);


var image_trials = [];
for (var i = 0; i < 600; i++) {
  //trigger marker on stimuli onset
  image_trials.push({
    type: jsPsychPsychophysics,
    stimuli: [
      {
        obj_type: 'rect',
        startX: 0,
        startY: 0,
        width: 200,
        height: 150,
        fill_color: '#000000',
        show_start_time: 0
      }
    ],
    trial_duration: 100,
    response_allowed_while_playing: false,
    choices: ["NO_KEYS"]
  }); 

  // Image trial
  var img = stimuli_images[i % stimuli_images.length];
  image_trials.push({
    type: jsPsychImageKeyboardResponse,
    stimulus: img,
    stimulus_height: 600,
    maintain_aspect_ratio: true,
    prompt: '<p>Press M for male and F for female',
    choices: ['m', 'f'],
    on_start: () => sendMarker('stimuli_onset')
  });
// Fixation trial
  image_trials.push(fixation);
;
}
timeline = timeline.concat(image_trials);

/* start the experiment */
    jsPsych.run(timeline);

  </script>
</html>